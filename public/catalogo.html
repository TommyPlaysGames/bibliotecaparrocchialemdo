<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Consulta il catalogo online della Biblioteca Parrocchiale Madonna dell'Olmo: cerca tra migliaia di libri di narrativa, saggistica, religione e altro."
    />
    <title>Catalogo Libri • Biblioteca Madonna dell'Olmo</title>
    <link rel="icon" href="/favicon.ico?v=2" sizes="any" />
    <link rel="shortcut icon" href="/favicon.ico?v=2" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=2">
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <header>
      <nav>
        <div class="logo">
          <a href="index.html">
            <img src="images/logo.png" alt="Logo Biblioteca" />
          </a>
        </div>
        <ul>
          <li><a href="./.">Home</a></li>
          <li><a href="./chi-siamo.html">Chi siamo</a></li>
          <li><a href="./storia.html">Storia</a></li>
          <li><a href="./catalogo.html">Catalogo Libri</a></li>
          <li><a href="./orari.html">Orari</a></li>
          <li><a href="./contatti.html">Contatti</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <h1>Catalogo Libri</h1>

      <input
        type="text"
        id="searchInput"
        placeholder="🔍 Cerca (titolo, autore, editore o genere) – ricerca completa nel database"
        style="
          width: 100%;
          padding: 10px;
          margin: 16px 0 8px;
          border-radius: 6px;
          border: none;
          background: #1f1f1f;
          color: #e0e0e0;
        "
      />

      <div class="table-responsive">
        <table id="tabellaLibri" class="catalogo-table">
          <colgroup>
            <col class="c-titolo" />
            <col class="c-autore" />
            <col class="c-editrice" />
            <col class="c-genere" />
          </colgroup>
          <thead>
            <tr>
              <th>Titolo</th>
              <th>Autore</th>
              <th>Casa Editrice</th>
              <th>Genere</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- sentinella per infinite scroll -->
        <div id="sentinel" style="height: 1px"></div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 Biblioteca Parrocchiale MDO</p>
    </footer>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabase = createClient(
        "https://zsyjukbcdbdwinaxytwa.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzeWp1a2JjZGJkd2luYXh5dHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDE5MjgsImV4cCI6MjA3NDkxNzkyOH0.P1SFxz98FRCn4TnVRLmG_mmohkglGWQateic6G4vnxk"
      );

      const input = document.getElementById("searchInput");
      const tbody = document.querySelector("#tabellaLibri tbody");
      const sentinel = document.getElementById("sentinel");

      // Stato ricerca + paginazione lato server
      let q = "";
      let from = 0;
      const pageSize = 50; // pubblico: batch più “leggero”
      let loading = false;
      let done = false;

      // Costruisci query
      const buildQuery = () => {
        let qb = supabase
          .from("libri")
          .select("id, titolo, autore, casa_editrice, genere")
          .order("titolo", { ascending: true });
        const s = q.trim();
        if (s) {
          qb = qb.or(
            `titolo.ilike.%${s}%,autore.ilike.%${s}%,casa_editrice.ilike.%${s}%,genere.ilike.%${s}%`
          );
        }
        return qb;
      };

      // Render
      function renderRows(rows) {
        rows.forEach((l) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td data-label="Titolo">${l.titolo ?? ""}</td>
            <td data-label="Autore">${l.autore ?? ""}</td>
            <td data-label="Casa Editrice">${l.casa_editrice ?? ""}</td>
            <td data-label="Genere">${l.genere ?? ""}</td>`;
          tbody.appendChild(tr);
        });
      }

      // Carica un batch
      async function loadBatch(reset = false) {
        if (loading || done) return;
        loading = true;

        if (reset) {
          from = 0;
          done = false;
          tbody.innerHTML = "";
        }

        const qb = buildQuery();
        const { data, error } = await qb.range(from, from + pageSize - 1);
        loading = false;

        if (error) {
          alert("Errore caricamento catalogo: " + error.message);
          return;
        }
        if (!data || data.length === 0) {
          done = true;
          return;
        }

        renderRows(data);
        from += data.length;
        if (data.length < pageSize) done = true;
      }

      // Debounce ricerca
      const debounce = (fn, ms = 300) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      };
      // Ricerca con debounce e reset automatico
      input?.addEventListener(
        "input",
        debounce(() => {
          q = input.value.trim();

          // Se la barra è vuota, resetta e ricarica tutto
          if (!q) {
            from = 0;
            done = false;
            tbody.innerHTML = "";
            loadBatch(true);
            return;
          }

          // Se c’è testo, esegui la ricerca filtrata
          from = 0;
          done = false;
          tbody.innerHTML = "";
          loadBatch(true);
        }, 300)
      );

      // Infinite scroll
      const io = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) loadBatch();
          });
        },
        { root: null, rootMargin: "200px", threshold: 0 }
      );
      io.observe(sentinel);

      // Primo caricamento
      loadBatch(true);
    </script>
  </body>
</html>
