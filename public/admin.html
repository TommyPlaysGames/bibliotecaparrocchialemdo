<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Area Amministratore ‚Ä¢ Biblioteca Madonna dell'Olmo</title>
    <link rel="icon" href="/favicon.ico?v=2" sizes="any" />
    <link rel="shortcut icon" href="/favicon.ico?v=2" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=2">
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <header>
      <nav>
        <div class="logo">
          <a href="index.html">
            <img src="images/logo.png" alt="Logo Biblioteca" />
          </a>
        </div>
        <ul>
          <li><a href="./.">Home</a></li>
          <li><a href="./chi-siamo.html">Chi siamo</a></li>
          <li><a href="./storia.html">Storia</a></li>
          <li><a href="./catalogo.html">Catalogo Libri</a></li>
          <li><a href="./orari.html">Orari</a></li>
          <li><a href="./contatti.html">Contatti</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <h1>Area Amministratore</h1>

      <!-- LOGIN -->
      <div id="loginDiv" class="contact-container">
        <h3>Accedi</h3>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
      </div>

      <!-- ADMIN -->
      <div id="adminDiv" class="contact-container" style="display:none">
        <button id="logoutBtn" class="copy-button">Logout</button>
        <br /><br />

        <h3>Aggiungi Libro</h3>
        <form id="libroForm">
          <input type="text" name="titolo" placeholder="Titolo" required />
          <input type="text" name="autore" placeholder="Autore" required />
          <input type="text" name="casa_editrice" placeholder="Casa Editrice" required />
          <select name="genere" required>
            <option value="">-- Seleziona Genere --</option>
            <option value="Narrativa">Narrativa</option>
            <option value="Saggistica">Saggistica</option>
            <option value="Ragazzi">Ragazzi</option>
            <option value="Religione">Religione</option>
            <option value="Altro">Altro</option>
          </select>
          <br /><br />
          <button type="submit">Aggiungi Libro</button>
          <br /><br />
        </form>

        <h3>Catalogo</h3>
        <input
          type="text"
          id="searchInput"
          placeholder="üîç Cerca (titolo, autore, editore o genere) ‚Äì ricerca completa nel database"
          style="width:100%;padding:10px;margin:16px 0 8px;border-radius:6px;border:none;background:#1f1f1f;color:#e0e0e0;"
        />

        <div class="table-responsive">
          <table id="tabellaLibri" class="admin-table">
            <colgroup>
              <col class="c-titolo" />
              <col class="c-autore" />
              <col class="c-editrice" />
              <col class="c-genere" />
              <col class="c-azioni" />
            </colgroup>
            <thead>
              <tr>
                <th>Titolo</th>
                <th>Autore</th>
                <th>Casa Editrice</th>
                <th>Genere</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="sentinel" style="height:1px;"></div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 Biblioteca Parrocchiale MDO</p>
    </footer>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabase = createClient(
        "https://zsyjukbcdbdwinaxytwa.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzeWp1a2JjZGJkd2luYXh5dHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDE5MjgsImV4cCI6MjA3NDkxNzkyOH0.P1SFxz98FRCn4TnVRLmG_mmohkglGWQateic6G4vnxk"
      );

      const loginDiv = document.getElementById("loginDiv");
      const adminDiv = document.getElementById("adminDiv");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const libroForm = document.getElementById("libroForm");
      const searchInput = document.getElementById("searchInput");
      const tbody = document.querySelector("#tabellaLibri tbody");
      const sentinel = document.getElementById("sentinel");

      const showLogin = () => { loginDiv.style.display = "block"; adminDiv.style.display = "none"; };
      const showAdmin = () => { loginDiv.style.display = "none"; adminDiv.style.display = "block"; };

      const escapeHtml = (s) => (s ?? "").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");

      // Stato
      let q = "";
      let from = 0;
      const pageSize = 100;
      let loading = false;
      let done = false;

      const buildQuery = () => {
        let qb = supabase.from("libri").select("*").order("titolo", { ascending: true });
        const s = q.trim();
        if (s) {
          qb = qb.or(`titolo.ilike.%${s}%,autore.ilike.%${s}%,casa_editrice.ilike.%${s}%,genere.ilike.%${s}%`);
        }
        return qb;
      };

      async function loadBatch(reset = false) {
        if (loading || done) return;
        loading = true;

        if (reset) {
          from = 0;
          done = false;
          tbody.innerHTML = "";
        }

        const { data, error } = await buildQuery().range(from, from + pageSize - 1);
        loading = false;

        if (error) return alert("Errore caricamento: " + error.message);
        if (!data || !data.length) { done = true; return; }

        data.forEach((l) => {
          const tr = document.createElement("tr");
          tr.dataset.id = l.id ?? "";
          tr.innerHTML = `
            <td data-field="titolo" contenteditable="true">${escapeHtml(l.titolo)}</td>
            <td data-field="autore" contenteditable="true">${escapeHtml(l.autore)}</td>
            <td data-field="casa_editrice" contenteditable="true">${escapeHtml(l.casa_editrice)}</td>
            <td data-field="genere" contenteditable="true">${escapeHtml(l.genere)}</td>
            <td class="actions">
              <button class="btn saveBtn">üíæ</button>
              <button class="btn deleteBtn">üóëÔ∏è</button>
            </td>`;
          tbody.appendChild(tr);
        });

        from += data.length;
        if (data.length < pageSize) done = true;
      }

      const debounce = (fn, ms=300) => {
        let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
      };

      // Ricerca con reset automatico
      searchInput?.addEventListener("input", debounce(() => {
        q = searchInput.value.trim();
        from = 0;
        done = false;
        tbody.innerHTML = "";
        loadBatch(true);
      }, 300));

      // Salva / Elimina
      tbody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const tr = btn.closest("tr");
        const id = tr?.dataset?.id;
        if (!id) return alert("ID mancante!");

        if (btn.classList.contains("deleteBtn")) {
          if (!confirm("Eliminare questo libro?")) return;
          const { error } = await supabase.from("libri").delete().eq("id", id);
          if (error) return alert("Errore eliminazione: " + error.message);
          loadBatch(true);
          return;
        }

        if (btn.classList.contains("saveBtn")) {
          const updated = {};
          tr.querySelectorAll("[data-field]").forEach((td)=>updated[td.dataset.field]=td.textContent.trim());
          const { error } = await supabase.from("libri").update(updated).eq("id", id);
          if (error) return alert("Errore aggiornamento: " + error.message);
          alert("Libro aggiornato!");
        }
      });

      // Inserimento
      libroForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nuovo = Object.fromEntries(new FormData(libroForm).entries());
        const { error } = await supabase.from("libri").insert([nuovo]);
        if (error) return alert("Errore inserimento: " + error.message);
        libroForm.reset();
        loadBatch(true);
        alert("Libro aggiunto!");
      });

      // LOGIN
      loginBtn?.addEventListener("click", async () => {
        try {
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;

          setTimeout(async () => {
            const { data } = await supabase.auth.getSession();
            if (data?.session) {
              showAdmin();
              await loadBatch(true);
            } else {
              alert("Sessione non attiva, riprova.");
            }
          }, 500);
        } catch (err) {
          alert("Errore login: " + err.message);
        }
      });

      logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        showLogin();
      });

      // Sessione iniziale
      (async () => {
        const { data } = await supabase.auth.getSession();
        if (data?.session) {
          showAdmin();
          loadBatch(true);
        } else {
          showLogin();
        }
      })();

      supabase.auth.onAuthStateChange((_e, session) => {
        if (session) { showAdmin(); loadBatch(true); }
        else { showLogin(); }
      });

      // Infinite scroll
      const io = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) loadBatch();
        });
      }, { root: null, rootMargin: "200px", threshold: 0 });
      io.observe(sentinel);
    </script>
  </body>
</html>
