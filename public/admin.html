<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Biblioteca Madonna dell'Olmo</title>
    <link rel="icon" href="/favicon.ico?v=2" sizes="any" />
    <link rel="shortcut icon" href="/favicon.ico?v=2" />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <script src="js/script.js"></script>

  <body>
    <header>
      <nav>
        <div class="logo">
          <a href="index.html">
            <img src="images/logo.png" alt="Logo Biblioteca" />
          </a>
        </div>
        <ul>
          <li><a href="./.">Home</a></li>
          <li><a href="./chi-siamo.html">Chi siamo</a></li>
          <li><a href="./storia.html">Storia</a></li>
          <li><a href="./catalogo.html">Catalogo Libri</a></li>
          <li><a href="./orari.html">Orari</a></li>
          <li><a href="./contatti.html">Contatti</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <h1>Area Amministratore</h1>

      <div id="loginDiv" class="contact-container">
        <h3>Accedi</h3>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
      </div>

      <div id="adminDiv" class="contact-container" style="display: none">
        <button id="logoutBtn" class="copy-button">Logout</button>
        <br /><br />

        <h3>Aggiungi Libro</h3>
        <form id="libroForm">
          <input type="text" name="titolo" placeholder="Titolo" required />
          <input type="text" name="autore" placeholder="Autore" required />
          <input
            type="text"
            name="casa_editrice"
            placeholder="Casa Editrice"
            required
          />
          <select name="genere" required>
            <option value="">-- Seleziona Genere --</option>
            <option value="Narrativa">Narrativa</option>
            <option value="Saggistica">Saggistica</option>
            <option value="Ragazzi">Ragazzi</option>
            <option value="Religione">Religione</option>
            <option value="Altro">Altro</option>
          </select>
          <br /><br />
          <button type="submit">Aggiungi Libro</button>
          <br /><br />
        </form>

        <h3>Catalogo</h3>
        <input
          type="text"
          id="searchInput"
          placeholder="üîç Cerca un libro (titolo, autore, casa editrice o genere)"
          style="
            width: 100%;
            padding: 10px;
            margin: 16px 0 8px;
            border-radius: 6px;
            border: none;
            background: #1f1f1f;
            color: #e0e0e0;
          "
        />
        <div class="table-responsive">
          <table id="tabellaLibri" class="admin-table">
            <colgroup>
              <col class="c-titolo" />
              <col class="c-autore" />
              <col class="c-editrice" />
              <col class="c-genere" />
              <col class="c-azioni" />
            </colgroup>
            <thead>
              <tr>
                <th>Titolo</th>
                <th>Autore</th>
                <th>Casa Editrice</th>
                <th>Genere</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 Biblioteca Parrocchiale Madonna dell'Olmo</p>
    </footer>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabase = createClient(
        "https://zsyjukbcdbdwinaxytwa.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzeWp1a2JjZGJkd2luYXh5dHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDE5MjgsImV4cCI6MjA3NDkxNzkyOH0.P1SFxz98FRCn4TnVRLmG_mmohkglGWQateic6G4vnxk"
      );

      const loginDiv = document.getElementById("loginDiv");
      const adminDiv = document.getElementById("adminDiv");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const libroForm = document.getElementById("libroForm");
      const tbody = document.querySelector("#tabellaLibri tbody");
      const searchInput = document.getElementById("searchInput");

      const showLogin = () => {
        loginDiv.style.display = "block";
        adminDiv.style.display = "none";
      };
      const showAdmin = () => {
        loginDiv.style.display = "none";
        adminDiv.style.display = "block";
      };

      const escapeHtml = (s) =>
        (s ?? "")
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

      let allBooks = [];
      let indexed = [];

      // --- Normalizzazione per la ricerca user-friendly
      const normalize = (s) =>
        (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") // rimuove accenti
          .replace(/[-‚Äì‚Äî_:/\\|;'".,!?(){}\[\]&@#*+=<>`~]/g, " ") // punteggiatura -> spazio
          .replace(/\s+/g, " ")
          .trim();

      function indexData(rows) {
        indexed = rows.map((r) => {
          const full = normalize(
            `${r.titolo} ${r.autore} ${r.casa_editrice} ${r.genere}`
          );
          const tokens = full.split(" ");
          return { r, tokens, full };
        });
      }

      function matches(rec, q) {
        const qs = normalize(q);
        if (!qs) return true;
        const qTokens = qs.split(" ");
        return qTokens.every((t) => rec.tokens.some((rt) => rt.startsWith(t)));
      }

      // --- Rendering tabella
      function render(rows) {
        tbody.innerHTML = rows
          .map(
            (l) => `
        <tr data-id="${l.id ?? ""}">
          <td data-label="Titolo" contenteditable="true" data-field="titolo">${escapeHtml(
            l.titolo
          )}</td>
          <td data-label="Autore" contenteditable="true" data-field="autore">${escapeHtml(
            l.autore
          )}</td>
          <td data-label="Casa Editrice" contenteditable="true" data-field="casa_editrice">${escapeHtml(
            l.casa_editrice
          )}</td>
          <td data-label="Genere" contenteditable="true" data-field="genere">${escapeHtml(
            l.genere
          )}</td>
          <td data-label="Azioni" class="actions">
            <button class="btn saveBtn">üíæ Salva</button>
            <button class="btn deleteBtn">üóëÔ∏è Elimina</button>
          </td>
        </tr>`
          )
          .join("");
      }

      async function caricaLibri() {
        const { data, error } = await supabase
          .from("libri")
          .select("*")
          .order("titolo");
        if (error) return alert("Errore caricamento: " + error.message);
        allBooks = data || [];
        indexData(allBooks);
        render(allBooks);
      }

      // üîç Ricerca live con debounce
      let timer;
      searchInput?.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          const q = searchInput.value;
          if (!q.trim()) {
            render(allBooks);
            return;
          }
          const results = indexed
            .filter((rec) => matches(rec, q))
            .map((x) => x.r);
          render(results);
        }, 250);
      });

      // --- Delega click su tabella
      tbody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const tr = btn.closest("tr");
        const id = tr?.dataset?.id;
        if (!id) return alert("ID libro mancante!");

        if (btn.classList.contains("deleteBtn")) {
          if (!confirm("Vuoi davvero eliminare questo libro?")) return;
          const { error } = await supabase.from("libri").delete().eq("id", id);
          if (error) return alert("Errore eliminazione: " + error.message);
          allBooks = allBooks.filter((b) => b.id !== id);
          indexData(allBooks);
          render(allBooks);
          return;
        }

        if (btn.classList.contains("saveBtn")) {
          const updated = {};
          tr.querySelectorAll("[data-field]").forEach((td) => {
            updated[td.dataset.field] = td.textContent.trim();
          });
          const { error } = await supabase
            .from("libri")
            .update(updated)
            .eq("id", id);
          if (error) return alert("Errore aggiornamento: " + error.message);
          alert("Libro aggiornato!");
          const i = allBooks.findIndex((b) => b.id === id);
          if (i >= 0) allBooks[i] = { ...allBooks[i], ...updated };
          indexData(allBooks);
        }
      });

      // --- Inserimento libro
      libroForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nuovoLibro = Object.fromEntries(
          new FormData(libroForm).entries()
        );
        const { data, error } = await supabase
          .from("libri")
          .insert([nuovoLibro])
          .select();
        if (error) return alert("Errore inserimento: " + error.message);
        allBooks.push(data[0]);
        indexData(allBooks);
        render(allBooks);
        libroForm.reset();
        alert("Libro aggiunto!");
      });

      // --- Login / Logout
      loginBtn?.addEventListener("click", async () => {
        try {
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const { error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });
          if (error) throw error;
          showAdmin();
          caricaLibri();
        } catch (err) {
          alert("Errore login: " + err.message);
        }
      });

      logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        showLogin();
      });

      // --- Controllo sessione iniziale
      (async () => {
        const { data } = await supabase.auth.getSession();
        if (data?.session) {
          showAdmin();
          caricaLibri();
        } else {
          showLogin();
        }
      })();

      supabase.auth.onAuthStateChange((_e, session) => {
        if (session) {
          showAdmin();
          caricaLibri();
        } else {
          showLogin();
        }
      });
    </script>
  </body>
</html>
